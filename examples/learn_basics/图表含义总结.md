# Qlib 量化策略图表详解

本文档详细解释 `workflow_by_code.ipynb` 生成的所有图表含义。

---

## 📊 图表目录

1. [report_graph - 策略全景分析](#1-report_graph---策略全景分析)
2. [risk_analysis_graph - 风险指标分析](#2-risk_analysis_graph---风险指标分析)
3. [score_ic_graph - IC时间序列](#3-score_ic_graph---ic时间序列)
4. [model_performance_graph - 模型表现分析](#4-model_performance_graph---模型表现分析)

---

## 1. report_graph - 策略全景分析

**代码：** `analysis_position.report_graph(report_normal_df)`

**图表数量：** 7个子图（垂直排列）

---

### 📈 子图1：累积收益对比

**三条主线：**

| 线条 | 全称 | 中文 | 含义 | 示例结果 |
|------|------|------|------|----------|
| `cum_bench` | Cumulative Benchmark | 累积基准收益 | 沪深300指数的累积涨跌幅 | 最终40%（涨40%） |
| `cum_return_wo_cost` | Cumulative Return Without Cost | 累积收益（不含成本） | 策略的累积收益（不扣手续费） | 最终100%（涨100%） |
| `cum_return_w_cost` | Cumulative Return With Cost | 累积收益（含成本） | 策略的累积收益（扣除手续费后） | 最终85%（涨85%） |

**灰色阴影区域：** 最大回撤发生的时间段（通常是2018年股市大跌期）

**怎么看：**
- ✅ 策略线（橙/绿）在基准线（蓝）上方 → 策略跑赢基准
- ✅ 线越陡 → 赚钱越快
- ⚠️ 线向下 → 回撤期（亏损）

**关键结论：**
- 策略跑赢基准：85% vs 40%，超额收益45%
- 交易成本影响：吃掉约15%收益（100% - 85%）

---

### 📉 子图2：每日超额收益（不含成本）

**指标：** `return_wo_mdd` = Return Without Cost Maximum Drawdown

**含义：** 策略相对历史最高点的回撤（不含交易成本）

**图表类型：** 红色填充柱状图

**Y轴范围：** -0.05 到 0（-5%到0%）

**怎么看：**
- 柱子向下延伸 = 回撤
- 回到0线 = 恢复到历史最高
- 最低点 = 最大回撤

**示例结果：** 最大回撤约-5.7%

---

### 📉 子图3：每日超额收益（含成本）

**指标：** `return_w_cost_mdd` = Return With Cost Maximum Drawdown

**含义：** 含交易成本后的最大回撤

**示例结果：** 最大回撤约-6.6%（比不含成本多1%）

---

### 📈 子图4：累积超额收益

**两条线：**

| 线条 | 全称 | 中文 | 含义 | 示例结果 |
|------|------|------|------|----------|
| `cum_ex_return_wo_cost` | Cumulative Excess Return Without Cost | 累积超额收益（不含成本） | 策略 - 基准（不含成本） | 最终65% |
| `cum_ex_return_w_cost` | Cumulative Excess Return With Cost | 累积超额收益（含成本） | 策略 - 基准（含成本） | 最终45% |

**含义：** 纯粹的"跑赢基准"部分，剥离了大盘涨跌的影响

**怎么看：**
- ✅ 持续上涨 → 稳定跑赢基准
- ❌ 波动剧烈 → 超额收益不稳定

---

### 🔄 子图5：换手率

**指标：** `turnover`

**含义：** 每天调仓的比例

**Y轴范围：** 0 到 1（0%到100%）

**示例结果：** 稳定在0.2（20%）

**解读：**
- 换手率20% = 每天有20%的仓位发生变化
- 换手率越高 → 交易成本越高
- 当前策略：每天换手20%导致交易成本较高

**优化建议：** 可以降低换手率以减少成本（调整策略参数）

---

### 📉 子图6 & 7：超额收益回撤细节

**指标：**
- `cum_ex_return_w_cost_mdd` - 含成本超额收益的最大回撤
- `cum_ex_return_wo_cost_mdd` - 不含成本超额收益的最大回撤

**图表类型：** 黄绿色填充区域

**含义：** 超额收益部分的波动区间

---

## 2. risk_analysis_graph - 风险指标分析

**代码：** `analysis_position.risk_analysis_graph(analysis_df, report_normal_df)`

**图表数量：** 5个（1个总览 + 4个月度图）

---

### 📊 图1：总体风险指标对比

**图表类型：** 4组柱状图

**X轴：** 两种情况对比
- `excess_return_without_cost` - 超额收益（不含成本）
- `excess_return_with_cost` - 超额收益（含成本）

**Y轴：** 4个风险指标

---

#### 指标1：std（Standard Deviation - 标准差/波动率）

**颜色：** 蓝色

**含义：** 超额收益的每日波动幅度

**示例值：**
- 不含成本：0.0057（0.57%）
- 含成本：0.0057（0.57%）

**解读：**
- 每天超额收益波动约0.57%
- 交易成本不影响波动率
- 数值越小 → 风险越低

---

#### 指标2：annualized_return（年化收益率）

**颜色：** 橙色

**含义：** 年化超额收益率

**示例值：**
- 不含成本：0.17（17%）
- 含成本：0.13（13%）

**解读：**
- 每年比基准多赚13%
- 交易成本吃掉4%年化收益
- **这是策略的核心指标！**

---

#### 指标3：information_ratio（信息比率）

**颜色：** 绿色

**公式：** `信息比率 = 年化超额收益 / 超额收益波动`

**含义：** 每承担1单位风险，能获得多少超额收益

**示例值：**
- 不含成本：1.97
- 含成本：1.45

**评价标准：**
- IR > 2：非常优秀
- IR > 1：不错 ✅（当前策略）
- IR > 0.5：一般
- IR < 0：亏钱

**解读：**
- 1.45的IR说明策略收益稳定
- 不是靠运气，是真实能力

---

#### 指标4：max_drawdown（最大回撤）

**颜色：** 红色

**含义：** 从最高点到最低点的最大跌幅

**示例值：**
- 不含成本：-0.057（-5.7%）
- 含成本：-0.066（-6.6%）

**解读：**
- 最惨的时候，超额收益回撤了6.6%
- 交易成本增加了约1%的回撤
- 数值越小（绝对值）→ 风险越低

---

### 📈 图2-5：月度风险指标时间序列

**4个图表分别显示：**
1. **annualized_return** - 每月年化收益率趋势
2. **max_drawdown** - 每月最大回撤趋势
3. **information_ratio** - 每月信息比率趋势
4. **std** - 每月波动率趋势

**X轴：** 月份（2017-01 到 2020-08）

**Y轴：** 对应指标的值

**怎么看：**
- 找出表现最好/最差的月份
- 分析季节性规律
- 识别策略失效期

---

## 3. score_ic_graph - IC时间序列

**代码：** `analysis_position.score_ic_graph(pred_label)`

**图表数量：** 1个

---

### 📊 图表：IC & Rank IC 时间序列

**两条线：**

#### 🔵 蓝色线：IC (Information Coefficient)

**全称：** Information Coefficient

**计算公式：**
```python
某天的IC = corr(当天300只股票的预测得分, 当天300只股票的实际涨跌)
```

**举例：**
```
2017-01-03 预测得分：
  SH600009: 0.03 (预测涨)
  SH600015: -0.14 (预测跌)
  SH600020: 0.02 (预测涨)
  ...

2017-01-03 实际涨跌：
  SH600009: +2.5%
  SH600015: -0.8%
  SH600020: +1.2%
  ...

IC = corr([0.03, -0.14, 0.02, ...], [2.5%, -0.8%, 1.2%, ...]) = 0.15
```

**含义：** 预测得分与实际收益的皮尔逊相关系数

**Y轴范围：** -1 到 1
- IC = 1：预测完全准确
- IC = 0：预测无效（瞎猜）
- IC = -1：预测完全相反

**示例结果：**
- 每日IC在 -0.4 到 0.5 波动
- **平均IC = 0.05（5%）** ✅

---

#### 🟠 橙色线：Rank IC

**全称：** Rank Information Coefficient

**计算公式：**
```python
Rank IC = corr(预测得分排名, 实际收益排名)
```

**区别：**
- IC：看绝对数值的相关性
- Rank IC：只看排名的相关性

**为什么重要：**
- TopK策略只在乎排名（选前50名）
- 不在乎具体涨多少
- **Rank IC更适合评估TopK策略**

**示例结果：**
- 平均Rank IC = 0.0515（5.15%）
- 略高于IC，说明模型更擅长预测排名

---

### 🔍 怎么看这个图？

**1. 看平均值（最重要！）**
- ✅ 平均IC = 5% > 0 → 模型有效
- ❌ 平均IC = 0 → 模型无效（瞎猜）

**2. 看位置**
- ✅ 大部分点在0轴上方 → 预测准确的天数多
- ❌ 大部分点在0轴下方 → 预测经常错

**3. 看波动**
- 每天IC剧烈波动 -0.4 到 0.5
- **这是正常的！** 市场每天都在变化
- 类比：篮球运动员单场10-30分波动，但场均20分 → 实力强

**4. 看趋势**
- 2017年初：IC较稳定在0.2左右
- 2018年中：IC波动加剧（熊市）
- 2019-2020：IC逐渐稳定

---

### 📏 评价标准

| 平均IC | 评价 |
|--------|------|
| > 0.10 | 卓越 🌟🌟🌟 |
| > 0.08 | 优秀 🌟🌟 |
| > 0.05 | 很好 🌟（当前策略） |
| > 0.03 | 不错 |
| > 0 | 有效 |
| = 0 | 无效（瞎猜） |
| < 0 | 预测反了 |

---

### 💡 关键结论

✅ **模型有真实预测能力**：平均IC=5%
✅ **正确多于错误**：大部分时间IC>0
✅ **擅长预测排名**：Rank IC略高于IC，适合TopK策略
⚠️ **存在波动**：不是每天都准，但长期有优势

---

## 4. model_performance_graph - 模型表现分析

**代码：** `analysis_model.model_performance_graph(pred_label)`

**图表数量：** 6个

---

### 📈 图1：Cumulative Return（分组累积收益）

**目的：** 验证模型能否区分好股票和坏股票

**步骤：**
1. 每天模型给300只股票打分（预测涨跌）
2. 按分数从高到低排序，分成5组（每组60只）
3. 追踪每组的实际收益（真实市场表现）
4. 看预测高分组是否真的涨得多

---

#### 6条线详细解释

**🔵 Group1 - 预测最好组**
- **选股逻辑**：每天选预测得分最高的60只股票（前20%）
- **示例结果**：累积涨150%
- **含义**：模型认为会大涨的，真的大涨了
- **如果模型无效**：应该和其他组差不多

**🟠 Group2 - 预测第二好**
- **选股逻辑**：预测得分第20%-40%的股票
- **示例结果**：累积涨70%
- **对比Group1**：涨幅只有一半
- **说明**：确实比Group1差

**🟢 Group3 - 预测中等**
- **选股逻辑**：预测得分中间20%的股票
- **示例结果**：累积涨40%
- **含义**：表现平平

**🔴 Group4 - 预测第四**
- **选股逻辑**：预测得分倒数20%-40%
- **预期**：应该涨得很少

**🟣 Group5 - 预测最差组**
- **选股逻辑**：预测得分最低的60只股票
- **示例结果**：累积涨90%
- **疑问**：为什么也涨这么多？
- **原因**：2017-2020整体是牛市，几乎所有股票都涨
  - 但注意：Group5涨90%，比Group1（150%）少60%
  - 在牛市中"涨得慢"就等于"差股票"

**🟤 long-short - 多空组合**
- **策略**：做多Group1 + 做空Group5
- **公式**：每天买入Group1，卖空Group5
- **示例结果**：累积涨210%
- **含义**：即使在牛市中，选对股票比瞎买强得多
- **这是最重要的指标！** 说明模型真的有预测能力

---

#### 关键结论

✅ **模型能识别好股票**：Group1涨最多
✅ **预测有区分度**：5组之间有明显差距
✅ **多空策略有效**：long-short赚210%，远超基准
⚠️ **在牛市环境**：所有组都涨，但涨幅有差异

---

### 📊 图2：收益分布直方图

**目的：** 看收益的统计特性（赚钱的概率、稳定性）

---

#### 左图：long-short 每日收益分布

**X轴：** 每日收益率（-2% 到 4%）
**Y轴：** 频数（出现次数）
**图形：** 钟形曲线（正态分布）

**关键指标：**
- **中心位置**：约在0.001（0.1%）
- **含义**：平均每天long-short赚0.1%

**解读：**
- ✅ **中心在0右侧**：多数时候赚钱（>0的天数 > <0的天数）
- ✅ **分布集中**：大部分天在-1%到2%之间，收益稳定
- ✅ **左右对称**：近似正态分布，符合统计规律

---

#### 右图：long-average 每日超额收益分布

**X轴：** 每日超额收益（-1%到2%）
**含义：** Group1 - 市场平均收益

**关键指标：**
- **中心位置**：约0.0005（0.05%）
- **含义**：Group1平均每天比市场多赚0.05%
- **年化计算**：252个交易日 × 0.05% ≈ 12.6%超额收益

**解读：**
- ✅ **中心在0右侧**：Group1经常跑赢平均
- ✅ **分布更窄**：波动比long-short小，风险更低

---

### 📈 图3：Information Coefficient (IC)

**与前面的IC图相同**，显示每日IC和Rank IC的时间序列。

---

### 🗺️ 图4：Monthly IC 热力图

**图表类型：** 热力图（Heatmap）

**坐标：**
- **X轴**：月份（1-12月）
- **Y轴**：年份（2017-2020）
- **颜色**：IC值
  - **深蓝色**：IC高（0.1+）- 预测非常准
  - **浅蓝色**：IC中等（0.05左右）- 预测还可以
  - **灰色**：IC接近0 - 预测无效
  - **橙色/红色**：IC低或负 - 预测失败

---

#### 逐年分析

**2017年（最下面一行）**
- 大部分是橙色/浅蓝色
- IC约在0.05-0.1之间
- 表现中等

**2018年（倒数第二行）**
- 3月、6月红色：IC很低（熊市）
- 8-9月蓝色：恢复正常

**2019年（倒数第三行）**
- 3月深红：IC最低的月份之一
- 5-6月红色：连续预测困难
- 其他月份蓝色：表现不错

**2020年（最上面一行）**
- 1-2月深蓝色：IC最高！
- 6-7月深蓝：预测准确
- 11-12月深蓝：年底表现优秀

---

#### 为什么某些月份IC低？

**可能原因：**
1. **重大政策**：监管新规、降准降息
2. **突发事件**：疫情、贸易战
3. **市场风格切换**：从大盘股转小盘股
4. **情绪主导**：恐慌or狂热，基本面预测失效

**红色月份的特点：**
- 市场非理性
- 基于历史数据的模型会失效
- 这是正常现象，无法避免

---

#### 关键结论

✅ **2020年模型最成熟**：深蓝色最多
✅ **能适应多数市场环境**：蓝色占主导
⚠️ **某些月份预测困难**：红色月份需注意
💡 **可以优化**：在红色月份减少仓位或暂停交易

---

### 📊 图5：IC分布分析

**包含两个子图：**

---

#### 左图：IC 直方图

**X轴：** IC值（-0.4 到 0.4）
**Y轴：** 频数（出现次数）
**图形：** 钟形曲线（正态分布）

**关键指标：**
- **峰值位置**：约在0.05
- **分布范围**：主要在-0.1到0.2
- **形状**：正态分布

**解读：**
- ✅ **峰值在0.05**：平均IC=0.05
- ✅ **中心>0**：正IC的天数 > 负IC的天数
- ✅ **正态分布**：符合统计规律，不是靠运气

**对比：如果模型无效（瞎猜）**
- 峰值应该在0
- 正负IC各占50%
- 长期平均IC=0

---

#### 右图：Q-Q Plot（分位数-分位数图）

**目的：** 验证IC是否服从正态分布

**X轴：** Normal Distribution Quantile（理论正态分位数）
**Y轴：** Observed Quantile（实际IC分位数）
**黑色直线：** 理论参考线
**蓝色点：** 实际数据

**怎么看：**
- ✅ **大部分点在线上**：IC接近正态分布
- ⚠️ **尾部有几个点偏离**：存在极端值（fat tail）
- **这很正常！** 金融市场总有黑天鹅

**为什么正态分布重要？**
1. **风险计算**：可以计算95%置信区间、极端亏损概率
2. **策略优化**：知道分布，可以优化仓位、设置止损线
3. **统计检验**：验证IC显著性，判断模型是否真的有效

---

#### 关键结论

✅ **IC分布健康**：钟形曲线，中心>0
✅ **近似正态**：Q-Q图大部分点在线上
✅ **存在极端值**：尾部有偏离（正常）
✅ **统计显著**：0.05的均值不是运气，是真实能力

---

### 📈 图6：Auto Correlation（预测自相关性）

**目的：** 看模型预测是否稳定，有没有过拟合

**X轴：** 时间（2017-2020）
**Y轴：** 自相关系数（0-0.8）

**计算公式：**
```python
Auto_Corr(t) = corr(今天的预测得分, 昨天的预测得分)
```

---

#### 举例说明

```
昨天(1月3日)的预测：
  SH600009: 0.03
  SH600015: -0.14
  SH600020: 0.02

今天(1月4日)的预测：
  SH600009: 0.025
  SH600015: -0.12
  SH600020: 0.018

Auto_Corr = corr([0.03,-0.14,0.02,...], [0.025,-0.12,0.018,...])
          = 0.6 (比较接近)
```

---

#### 不同数值的含义

**自相关 = 1（完全相关）**
- 今天预测 = 昨天预测
- 模型只是照搬昨天的结果
- ❌ 问题：无法捕捉市场变化，无用的模型

**自相关 = 0（完全无关）**
- 今天预测和昨天完全不同
- ❌ 问题：预测不稳定，过于随机，交易成本高

**自相关 = 0.3-0.7（适度相关）**
- 今天预测与昨天有关联，但有调整
- ✅ 优点：有延续性，又能适应新信息
- **这是理想状态！**

---

#### 示例结果

**数值范围：** 0.3-0.7，平均约0.5

**波动：**
- 有时高（0.7）：市场稳定，预测延续性强
- 有时低（0.3）：市场变化，预测调整大

---

#### 关键结论

✅ **预测稳定性适中**：自相关0.5
✅ **不是简单重复**：能捕捉新信息
✅ **不是过度敏感**：不会每天大变
✅ **交易成本可控**：不会频繁换股

**类比：**
- 天气预报：今天预测明天下雨，明天预报后天也可能下雨（有延续），但如果气压变化，会调整预报（有适应）
- **自相关0.5** = 既考虑趋势，又关注变化

---

## 📚 附录：关键术语表

| 术语 | 全称 | 中文 | 含义 |
|------|------|------|------|
| **cum** | cumulative | 累积的 | 从开始到现在的总和 |
| **ex** | excess | 超额的 | 相对基准的差值 |
| **wo** | without | 不含 | 不包括交易成本 |
| **w** | with | 含 | 包括交易成本 |
| **mdd** | Maximum Drawdown | 最大回撤 | 从最高点到最低点的最大跌幅 |
| **IC** | Information Coefficient | 信息系数 | 预测值与真实值的相关系数 |
| **IR** | Information Ratio | 信息比率 | 超额收益/超额收益波动 |
| **std** | Standard Deviation | 标准差 | 波动率，风险的衡量 |
| **corr** | correlation | 相关系数 | 两个变量的线性关系强度 |

---

## 🎯 总结：6组图表的层次关系

| 图表组 | 回答的问题 | 关键结论 |
|--------|-----------|----------|
| **report_graph** | 策略整体表现如何？ | ✅ 跑赢基准45%，换手率20% |
| **risk_analysis_graph** | 风险收益比如何？ | ✅ IR=1.45，年化超额13%，回撤6.6% |
| **score_ic_graph** | 每天预测准吗？ | ✅ 平均IC=5%，有预测能力 |
| **model_performance (分组)** | 能区分好坏股票吗？ | ✅ Group1涨150%，long-short涨210% |
| **model_performance (分布)** | 收益稳定吗？ | ✅ 正态分布，赚钱概率>50% |
| **model_performance (IC分析)** | IC分布合理吗？ | ✅ 正态分布，统计显著 |
| **model_performance (自相关)** | 预测稳定吗？ | ✅ 自相关0.5，稳定且灵活 |

---

## 🌟 综合评价

**基于2017-2020年回测数据，该量化策略：**

✅ **预测能力强**：IC=5%，统计显著
✅ **收益优秀**：年化超额13%，跑赢基准45%
✅ **风险可控**：最大回撤6.6%，IR=1.45
✅ **统计稳健**：正态分布，符合理论假设
✅ **策略合理**：自相关0.5，稳定且适应性强
⚠️ **交易成本高**：换手率20%，吃掉4%年化收益

**优化建议：**
1. 降低换手率（调整TopK策略参数，如增大n_drop）
2. 在IC低的月份（热力图红色区域）降低仓位
3. 考虑多空策略（long-short收益更高）

**总体评价：这是一个表现优秀、统计稳健、值得进一步优化的量化模型！** 🎉
